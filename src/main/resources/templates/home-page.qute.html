{#include base}
  <div class="flex flex-row">
      {#include resources-view /}

      <div class="w-full mx-0 my-2 px-2 flex max-md:flex-col md:items-start text-zinc-700 overflow-x-hidden">
        <style>
          td, th {
            padding: 0.5rem;
            padding-right: 0;

            line-height: 1.25rem;
            text-align: left;
          }
          @media screen and (min-width: 640px) {
            td, th {
              padding: 0.75rem;
              padding-right: 0;

              line-height: 1.5rem;
            }
          }

          .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          .menu-item {
            height: 2.75rem;
            display: flex;
            align-items: center;

            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            padding-right: 1rem;
            border-bottom-width: 1px;
            border-color: rgb(228 228 231);

            cursor: pointer;
            user-select: none; /* to now show select text cursor */
          }
          .menu-item:hover {
            color: white;
            background-color: #326CE5;
          }
          .menu-item:last-child {
              border-bottom: none;
          }

          .mobile-command-item {
              flex-grow: 1;
              display: flex;
              justify-content: center;
              align-items: center;

              width: 25vw;
              max-width: 15.5rem;
              height: 4rem;
              margin: 0.15rem;

              background-color: #326CE5; /* = bg-primary */
              border-radius: 1.0rem;
              user-select: none; /* to now show select text cursor */
          }

          /* remove black drop down arrow in WebKit based browsers */
          input[type="text"]::-webkit-calendar-picker-indicator,
          input[type="search"]::-webkit-calendar-picker-indicator {
              display: none !important;
          }
        </style>

        <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

        <div id="commandInputContainer" class="fixed flex items-center w-[20rem] h-[3.5rem] p-2 top-1 right-1 z-[999] bg-primary hidden">
          <input type="search" list="availableCommands" class="w-full h-full p-2 px-1 rounded-full focus:outline-none"
                 onchange="commandInputChanged(event)" onkeydown="commandInputKeyDown(event)" onblur="commandInputLostFocus(event)" />
          <datalist id="availableCommands">
            {#for entry in commandNamesToUrlPath}
              <option value="{entry.key}"></option>
            {/for}
          </datalist>
        </div>

        <div id="resourceItemsContainer" class="flex flex-col" hx-swap="outerHTML">
          {#fragment id=resourceItems}
            <table class="table-fixed w-full bg-white text-xs sm:text-sm py-4 pr-2 sm:pr-3 text-zinc-700 shadow-md bg-clip-border"
                   {#if resource.isWatchable}hx-ext="sse" sse-connect="{createWatchResourcePath()}" sse-swap="resourceItemsUpdated"{/if}>
              <thead class="bg-zinc-200 text-zinc-500 border-b border-zinc-500 hidden lg:table-header-group">
                  <tr>
                    <th class="w-[5.5rem] sm:w-[12rem] text-left {#if !resource.isNamespaced || selectedNamespace != null}hidden{/if}">Namespace</th>
                    <th>Name</th>
                    {#if resource.isPod}
                      <th class="w-[3.5rem]">Ready</th>
                      <th class="w-[6rem]">Status</th>
                    {/if}
                    {#for headerName in resource.getAdditionalValuesNames()}
                      <th>{headerName}</th>
                    {/for}
                    <th class="w-12 p-0"></th>
                  </tr>
              </thead>

              <tbody>
                {#for item in resourceItems}
                  <tr class="border-b first:border-t border-zinc-200 even:bg-zinc-100/50 {item.getItemStyle()}lg:hover:bg-[#326CE5] lg:hover:text-white" tabindex="0"
                      {#if resource.isLoggable}data-logs-url="logs/{resource.name}/{item.namespace}/{item.name}"{/if}
                      onmousedown="onTableRowMouseDown(event)" oncontextmenu="showMenu(this, event)"
                      onkeydown="onTableRowKeyDown(event, '{resource.name}', '{resource.kind}', '{item.namespace}', '{item.name}', {resource.isScalable}, {resource.isDeletable}, {resource.allowDeletingWithoutConfirmation})"
                  >
                    {! mobile view !}
                    <td class="flex flex-col justify-center min-h-[3.25rem]">
                      <div class="flex items-center">
                        {#if resource.isNamespaced && selectedNamespace == null}<div class="w-[5.5rem] sm:w-[12rem] mr-2 flex-[0_0_auto] truncate">{item.namespace}</div>{/if}
                        <div class="grow truncate">{item.name}</div>
                        {#if resource.isPod}
                          <div class="w-4 ml-1 text-center flex-[0_0_auto]">{item.countReadyContainers}/{item.container.size}</div>
                          <div class="w-[3.5rem] ml-1 flex-[0_0_auto]">{item.status}</div>
                        {/if}
                      </div>
                      {#if item.additionalValues}
                        <div class="flex items-center mt-1">
                          {#for keyValue in item.additionalValues}
                            <div class="mr-1">{keyValue.key}: {keyValue.value}</div>
                          {/for}
                        </div>
                      {/if}
                    </td>
                    {! desktop view !}
                    <td class="truncate hidden {#if resource.isNamespaced && selectedNamespace == null}lg:table-cell{/if}">{item.namespace}</td>
                    <td class="truncate hidden lg:table-cell">{item.name}</td>
                    {#if resource.isPod}
                      <td class="text-center hidden lg:table-cell">{item.countReadyContainers}/{item.container.size}</td>
                      <td class="hidden lg:table-cell">{item.status}</td>
                    {/if}
                    {#for keyValue in item.additionalValues}
                      <td class="hidden lg:table-cell">{keyValue.value}</td>
                    {/for}
                    <td class="w-8 sm:w-12 p-0">
                      <div class="menu-toggler flex justify-center items-center w-full h-full text-zinc-500 lg:hover:text-white text-3xl cursor-pointer" onclick="showMenu(this, event)">&#xFE19;</div>
                      <div class="menu fixed min-w-[9rem] right-2 bg-white text-zinc-700 text-xl shadow-xl z-10 hidden">
                        <ul class="list-none">
                          {#if resource.isLoggable}<li class="menu-item" onclick="showLogs(event)" data-logs-url="logs/{resource.name}/{item.namespace}/{item.name}">Logs</li>{/if}
                          {#if resource.isScalable}<li class="menu-item" onclick="scaleTo(event, '{resource.name}', '{resource.kind}', '{item.namespace}', '{item.name}')">Scale</li>{/if}
                          {#if resource.isDeletable}<li class="menu-item" onclick="deleteItem(event, '{resource.name}', '{resource.kind}', '{item.namespace}', '{item.name}')">Delete</li>{/if}
                          {#if resource.allowDeletingWithoutConfirmation}<li class="menu-item" onclick="killItem(event, '{resource.name}', '{item.namespace}', '{item.name}')">Kill</li>{/if}
                        </ul>
                      </div>
                    </td>
                  </tr>
                {/for}
              </tbody>
            </table>

            <script type="text/javascript">
              selectedContext = {#if selectedContext}"{selectedContext}"{#else}null{/if}
              selectedNamespace = {#if selectedNamespace}"{selectedNamespace}"{#else}null{/if}
              currentPath = "page/resources/{resource.group ?: "null"}/{resource.name}"
            </script>

          {/fragment}

        </div>

        <div class="fixed w-12 h-12 right-1 bottom-1 p-[0.2rem] bg-primary text-2xl font-bold rounded-lg shadow-md select-none z-[999]"
             onclick="document.getElementById('commandsContainer').classList.toggle('hidden'); return false;">
          <img alt="Kubernetes Logo" src="assets/images/kubernetes-icon-color.svg">
        </div>
        <div id="commandsContainer" class="fixed right-1 bottom-[3.5rem] max-md:left-1 md:max-w-[760px] bg-zinc-200 text-white rounded-2xl shadow-md z-[998] hidden">
          <div class="flex justify-evenly content-stretch mt-[0.15rem] p-[0.125rem]">
            <div class="flex-[1_0_auto] w-[24vw] max-w-[32vw] lg:max-w-[15.5rem] invisible"></div>
            <div class="flex items-center flex-[1_0_auto] w-[25vw] max-w-[32vw] lg:max-w-[15.5rem] h-16 p-2 pl-1 bg-primary rounded-2xl">
              <label for="selectCustomResourceDefinition" class="w-8">CRD</label>
              <select id="selectCustomResourceDefinition" class="w-full h-[2.75rem] ml-1 pl-1 bg-white text-primary rounded-lg" aria-label="Select custom resource definition"
                      onchange="displayResourceItemsFromSelectBox(JSON.parse(this.value), event)">
                {#for resource in customResourceDefinitions}
                  <option value='{ "group": "{resource.group}", "name": "{resource.name}" }'>{resource.kind}</option>
                {/for}
              </select>
            </div>
            <div class="flex items-center flex-[1_0_auto] w-[24vw] max-w-[32vw] lg:max-w-[15.5rem] h-16 p-2 pl-1 bg-primary rounded-2xl">
              <label for="selectStandardResource" class="w-8">Std<br/>Res</label>
              <select id="selectStandardResource" class="w-full h-[2.75rem] ml-1 pl-1 bg-white text-primary rounded-lg" aria-label="Select standard resource"
                      onchange="displayResourceItemsFromSelectBox(JSON.parse(this.value), event)">
                {#for resource in standardResources}
                  <option value='{ "group": "{resource.group}", "name": "{resource.name}" }'>{resource.kind}</option>
                {/for}
              </select>
            </div>
          </div>

          <div class="flex justify-evenly content-stretch mt-[0.15rem] p-[0.125rem]">
            <div class="flex-[1_0_auto] w-[25vw] max-w-[32vw] lg:max-w-[15.5rem] invisible"></div>
            <div class="flex items-center flex-[1_0_auto] w-[25vw] max-w-[32vw] lg:max-w-[15.5rem] h-16 p-2 pl-1 bg-primary rounded-2xl">
              <label for="selectContext" class="w-8">cxt</label>
              <select id="selectContext" class="w-full h-[2.75rem] ml-1 pl-1 bg-white text-primary rounded-lg" aria-label="Select namespace"
                      onchange="switchToContext(this.value, event)">
                {#for context in contexts}
                  <option value="{context}" {#if context == selectedContext || (selectedContext == null && context == defaultContext)}selected{/if}>{context}</option>
                {/for}
              </select>
            </div>
            <div class="flex items-center flex-[1_0_auto] w-[25vw] max-w-[32vw] lg:max-w-[15.5rem] h-16 p-2 pl-1 bg-primary rounded-2xl">
              <label for="selectNamespace" class="w-8">ns</label>
              <select id="selectNamespace" class="w-full h-[2.75rem] ml-1 pl-1 bg-white text-primary rounded-lg" aria-label="Select namespace"
                      onchange="switchToNamespace(this.value, event)">
                <option value=null {#if selectedNamespace == null}selected{/if}>all</option>
                {#for namespace in allNamespaces}
                  <option value="{namespace.name}" {#if namespace.name == selectedNamespace}selected{/if}>{namespace.name}</option>
                {/for}
              </select>
            </div>
          </div>

          <div class="flex justify-evenly flex-wrap py-[0.125rem]">
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'persistentvolumes', event)">PV</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'persistentvolumeclaims', event)">PVC</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'nodes', event)">Nodes</div>

            <div class="mobile-command-item" onclick="displayResourceItems('rbac.authorization.k8s.io', 'rolebindings', event)">RoleBindings</div>
            <div class="mobile-command-item" onclick="displayResourceItems('rbac.authorization.k8s.io', 'clusterroles', event)">ClusterRoles</div>
            <div class="mobile-command-item" onclick="displayResourceItems('rbac.authorization.k8s.io', 'roles', event)">Roles</div>

            <div class="mobile-command-item" onclick="displayResourceItems(null, 'serviceaccounts', event)">ServiceAccounts</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'secrets', event)">Secrets</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'configmaps', event)">ConfigMaps</div>

            <div class="mobile-command-item" onclick="displayResourceItems('apps', 'daemonsets', event)">DaemonSets</div>
            <div class="mobile-command-item" onclick="displayResourceItems('apps', 'statefulsets', event)">StatefulSets</div>
            <div class="mobile-command-item" onclick="displayResourceItems('apps', 'deployments', event)">Deployments</div>

            <div class="mobile-command-item" onclick="displayResourceItems('networking.k8s.io', 'ingresses', event)">Ingresses</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'services', event)">Services</div>
            <div class="mobile-command-item" onclick="displayResourceItems(null, 'pods', event)">Pods</div>
          </div>
        </div>
      </div>

      <script type="text/javascript">
        var selectedContext = {#if selectedContext}"{selectedContext}"{#else}null{/if}
        var selectedNamespace = {#if selectedNamespace}"{selectedNamespace}"{#else}null{/if}
        var currentPath = "page/resources/{resource.group ?: "null"}/{resource.name}"

        const commandNamesToUrlPath = new Map() // copy commands so that we can access them from JavaScript
        {#for entry in commandNamesToUrlPath}
          commandNamesToUrlPath.set("{entry.key}", {entry.value.raw})
        {/for}
        const commandInputContainer = document.getElementById("commandInputContainer")
        const commandInput = commandInputContainer.querySelector("input")
        const commandsContainer = document.getElementById("commandsContainer")
        const resourceItemsContainer = document.getElementById("resourceItemsContainer")
        var selectedItem = null
        var previousFocusedElement = null
        const isTouchDevice = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0)

        initializeTable()

        const observer = new MutationObserver((mutationList) => {
          initializeTable() // table data has changed, so re-initialize table
        })
        observer.observe(resourceItemsContainer, { childList: true })

        function initializeTable() {
          if (isTouchDevice == false) {
            const firstTableRow = resourceItemsContainer.querySelector("tbody tr")
            if (firstTableRow) { // there are items in the table
              selectedItem = firstTableRow
              selectedItem.focus()
            }
          }
        }

        function displayResourceItemsFromSelectBox(resource, event) {
          displayResourceItems(resource.group, resource.name, event)
        }

        function displayResourceItems(resourceGroup, resourceName, event) {
          let path = getResourcesPath(resourceGroup, resourceName, selectedNamespace)

          executeHtmxRequest(path)

          if (event.srcElement.classList.contains("mobile-command-item") || event.srcElement.id == "selectStandardResource" || event.srcElement.id == "selectCustomResourceDefinition") { // a mobile command item has been clicked ..
            commandsContainer.classList.add("hidden") // .. -> hide commandsContainer again
            event.preventDefault() // stop propagating so that it won't reach window.onclick listener which hides commandsContainer
          }
        }

        function switchToContext(context, event) {
          commandsContainer.classList.add("hidden")

          window.location.search = "?context=" + context
        }

        function switchToNamespace(namespace, event) {
          const path = appendContextAndNamespaceToPath(currentPath, namespace)

          executeHtmxRequest(path)

          commandsContainer.classList.add("hidden")
        }

        function getResourcesPath(resourceGroup, resourceName, namespace) {
          const path = `page/resources/$\{resourceGroup || "null"}/$\{resourceName}`

          return appendContextAndNamespaceToPath(path, namespace)
        }

        function appendContextAndNamespaceToPath(path, namespace) {
          const url = new URL(path, window.location)

          if (selectedContext) {
            url.searchParams.append("context", selectedContext)
          }
          if (namespace && namespace != "null" && namespace != " ") {
            url.searchParams.append("namespace", namespace)
          }

          return url.pathname + url.search
        }

        function executeHtmxRequest(path, verb) {
          htmx.ajax(verb || "GET", path, "#resourceItemsContainer")
        }

        window.onkeydown = (event) => {
          if (event.key == ":" && document.activeElement != commandInput) { // show and focus commandInput on ':'
            previousFocusedElement = document.activeElement // store current focused element to restore focus when hiding commandInput
            commandInputContainer.classList.remove("hidden")
            commandInput.focus()
            event.preventDefault()
          }
        }

        function onTableRowMouseDown(event) {
          if (isTouchDevice == false) {
            const parentRowElement = getRowElement(event)
            if (parentRowElement) {
              setFocusTo(null, parentRowElement) // do not prevent default -> null for event
            }
          }
        }

        function getRowElement(event) {
          if (event.srcElement.tagName == "TR") {
            return event.srcElement
          }

          return event.srcElement.closest("tr")
        }

        function onTableRowKeyDown(event, resourceName, resourceKind, namespace, itemName, isScalable, isDeletable, allowDeletingWithoutConfirmation) {
          if (noModifierKeyPressed(event)) {
            if (event.code == "ArrowDown") {
              setFocusTo(event, selectedItem?.nextElementSibling)
            }
            else if (event.code == "ArrowUp") {
              setFocusTo(event, selectedItem?.previousElementSibling)
            }
            else if (event.code == "KeyL") {
              if (selectedItem == event.srcElement) {
                showLogs(event)
              }
            } else if (isScalable && event.code == "KeyS") {
              scaleTo(event, resourceName, resourceKind, namespace, itemName)
            }
          }
          else if (ctrlIsTheOnlyPressedModifierKey(event)) {
            if (isDeletable && event.code == "KeyD") {
              deleteItem(event, resourceName, resourceKind, namespace, itemName)
            } else if (isDeletable && allowDeletingWithoutConfirmation && event.code == "KeyK") {
              killItem(event, resourceName, namespace, itemName)
            }
          }
        }

        function showLogs(event) {
          if (event.srcElement.dataset.logsUrl) {
            closeMenu(event) // in case a menu item has been clicked, close menu again
            event.preventDefault()

            const path = appendContextAndNamespaceToPath(event.srcElement.dataset.logsUrl, null)
            window.open(path, "_blank", "popup=true,toolbar=true")
          }
        }

        function scaleTo(event, resourceName, resourceKind, namespace, itemName) {
          closeMenu(event) // in case a menu item has been clicked, close menu again
          event.preventDefault() // prevent key 'S' from bubbling on

          setTimeout(() => { // so that menu first gets hidden and isn't still visible when prompt dialog gets shown wait 1 millisecond
            const countReplica = window.prompt(`Scale $\{resourceKind} $\{namespace}/$\{itemName}? Replicas:`)
            if (countReplica) {
              const itemPath = getItemPath(resourceName, namespace, itemName)
              executeHtmxRequest(itemPath + "?scaleTo=" + countReplica, "PATCH")
            }
          }, 1)
        }

        function deleteItem(event, resourceName, resourceKind, namespace, itemName) {
          closeMenu(event) // in case a menu item has been clicked, close menu again
          event.preventDefault() // prevent Ctrl+D from bubbling on

          setTimeout(() => { // so that menu first gets hidden and isn't still visible when confirmation dialog gets shown wait 1 millisecond
            if (window.confirm(`Are you sure you want to delete $\{resourceKind} $\{itemName}?`)) {
              const itemPath = getItemPath(resourceName, namespace, itemName)
              executeHtmxRequest(itemPath, "DELETE")
            }
          }, 1)
        }

        function killItem(event, resourceName, namespace, itemName) {
          closeMenu(event) // in case a menu item has been clicked, close menu again
          event.preventDefault() // prevent Ctrl+K from bubbling on

          const itemPath = getItemPath(resourceName, namespace, itemName)
          executeHtmxRequest(itemPath, "DELETE")
        }

        function getItemPath(resourceName, namespace, itemName) {
          return `resource/$\{resourceName}/$\{namespace}/$\{itemName}`
        }

        function showMenu(element, event) {
          closeAllMenus()
          let menu = element.nextElementSibling

          if (event.type == "contextmenu") {
            menu = element.querySelector(".menu")

            menu.style.top = `$\{event.clientY}px`
            menu.style.left = `$\{event.clientX}px`
            menu.style.right = "unset"
          } else {
            const elementRect = element.getBoundingClientRect()
            menu.style.top = `$\{elementRect.bottom}px`
            menu.style.left = "unset"
            menu.style.right = "0.5rem"
          }

          menu.classList.toggle('hidden')
          event.preventDefault()
        }

        function closeMenu(event) {
          const menu = event.srcElement.closest(".menu")
          menu?.classList?.add("hidden") // in case a menu item has been clicked, close menu again
        }

        function closeAllMenus() {
          document.querySelectorAll(".menu").forEach((menu) =>
            menu.classList.add("hidden")
          )
        }

        function setFocusTo(event, item) {
          if (item) {
            selectedItem = item
            item.focus()
            event?.preventDefault()
          }
        }

        function noModifierKeyPressed(event) {
          return !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey
        }

        function ctrlIsTheOnlyPressedModifierKey(event) {
          return event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey
        }

        function commandInputChanged(event) {
            const hasFocus = document.activeElement == commandInput
            if (hasFocus == false) { // this method also gets fired when commandInput just gets hidden, e.g. when pressing Escape ->
              event.preventDefault()
              return
            }

            const commandToExecute = commandNamesToUrlPath.get(event.srcElement.value)
            if (commandToExecute) {
              const commandName = commandToExecute.command
              switch (commandName) {
                case "displayResourceItems":
                  displayResourceItems(commandToExecute.resourceGroup, commandToExecute.resourceName, event)
                  break
                case "switchToNamespace":
                  switchToNamespace(commandToExecute.namespace, event)
                  break
                case "switchToContext":
                  switchToContext(commandToExecute.context, event)
                  break
                default:
                  console.warn("Unknown command to execute encountered:", commandToExecute, "Known commands are: displayResourceItems, switchToContext, switchToNamespace")
              }
              eval(commandToExecute)
            }
        }

        function commandInputKeyDown(event) {
          if (event.code == "Escape") { // hide commandInput on Escape
            commandInput.blur()
            event.preventDefault()
          }
        }

        function commandInputLostFocus(event) {
          commandInputContainer.classList.add("hidden")
          commandInput.value = ""
          previousFocusedElement?.focus()
        }

        document.addEventListener("click", (event) => {
          if (event.defaultPrevented == false) {
            if (commandsContainer.contains(event.srcElement) == false) {
              commandsContainer.classList.add("hidden") // click outside commandsContainer -> hide commandsContainer again
            }

            if (event.srcElement.classList.contains("menu-toggler") == false) {
              closeAllMenus() // click outside menus -> hide menus again
            }
          }
        })

      </script>
  </div>
{/include}