{#include base}
  <div class="flex flex-row">
      {#include resources-view /}

      <div class="w-full mx-0 my-2 px-2 flex max-md:flex-col md:items-start text-zinc-700 overflow-x-hidden">
        <style>
          td, th {
            padding: 0.5rem;
            padding-right: 0;

            line-height: 1.25rem;
            text-align: left;
          }
          @media screen and (min-width: 640px) {
            td, th {
              padding: 0.75rem;
              padding-right: 0;

              line-height: 1.5rem;
            }
          }

          .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          }

          .mobile-command-item {
              flex-grow: 1;
              display: flex;
              justify-content: center;
              align-items: center;

              width: 25vw;
              max-width: 15.5rem;
              height: 4rem;
              margin: 0.15rem;

              background-color: #326CE5; /* = bg-primary */
              border-radius: 1.0rem;
          }

          /* remove black drop down arrow in WebKit based browsers */
          input[type="text"]::-webkit-calendar-picker-indicator,
          input[type="search"]::-webkit-calendar-picker-indicator {
              display: none !important;
          }
        </style>

        <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

        <div id="commandInputContainer" class="fixed flex items-center w-[20rem] h-[3.5rem] p-2 top-1 right-1 z-[999] bg-primary hidden">
          <input type="search" list="availableCommands" class="w-full h-full p-2 px-1 rounded-full focus:outline-none"
                 onkeydown="commandInputKeyDown(event)" onblur="commandInputLostFocus(event)"
                 hx-trigger="change" hx-get="page/resources/<resourcePath>?namespace={selectedNamespace}" hx-target="#resourceItemsContainer" />
          <datalist id="availableCommands">
            {#for entry in commandNamesToUrlPath}
              <option value="{entry.key}"></option>
            {/for}
          </datalist>
        </div>

        <div id="resourceItemsContainer" class="flex flex-col">
          {#fragment id=resourceItems}
            <table class="table-fixed w-full bg-white text-xs sm:text-sm py-4 pr-2 sm:pr-3 text-zinc-700 shadow-md bg-clip-border"
                    hx-ext="sse" sse-connect="watch/resources/{resource.group ?: "null"}/{resource.name}?namespace={selectedNamespace}" sse-swap="resourceItemsUpdated">
              <thead class="bg-zinc-200 text-zinc-500 border-b border-zinc-500">
                  <tr>
                      <th class="w-[7.25rem] sm:w-[12rem] text-left {#if !resource.isNamespaced || selectedNamespace != null}hidden{/if}">Namespace</th>
                      <th>Name</th>
                  </tr>
              </thead>

              <tbody>
                {#for item in resourceItems}
                  <tr class="border-b border-zinc-200 even:bg-zinc-100/50 lg:hover:bg-zinc-200" tabindex="0"
                      {#if resource.isLoggable}data-logs-url="logs/{resource.name}/{item.namespace}/{item.name}"{/if}
                      onmousedown="onTableRowMouseDown(event)" onkeydown="onTableRowKeyDown(event)"
                      {#if resource.isScalable} hx-trigger="keydown[code=='KeyS']" hx-patch="resource/{resource.name}/{item.namespace}/{item.name}" hx-prompt="Scale {resource.kind} {item.namespace}/{item.name}? Replicas:"{/if}
                      {#if resource.isDeletable} hx-trigger="keydown[ctrlKey && code=='KeyD']" hx-delete="resource/{resource.name}/{item.namespace}/{item.name}" hx-confirm="Are you sure you want to delete {resource.kind} {item.name}?"{/if}
                  >
                    <td class="truncate {#if !resource.isNamespaced || selectedNamespace != null}hidden{/if}">{item.namespace}</td>
                    <td class="truncate">{item.name}</td>
                  </tr>
                {/for}
              </tbody>
              </table>

          {/fragment}

        </div>

        <div class="fixed w-12 h-12 right-1 bottom-1 p-[0.2rem] bg-primary text-2xl font-bold rounded-lg shadow-md select-none z-[999]"
             onclick="document.getElementById('commandsContainer').classList.toggle('hidden'); return false;">
          <img alt="Kubernetes Logo" src="assets/images/kubernetes-icon-color.svg">
        </div>
        <div id="commandsContainer" class="fixed right-1 bottom-[3.5rem] max-md:left-1 md:max-w-[760px] bg-gray-300 text-white rounded-2xl shadow-md z-[998] hidden">
          <div class="flex justify-evenly content-stretch mt-[0.15rem] p-[0.125rem]">
            <div class="flex-[1_0_auto] w-[25vw] max-w-[15.5rem] invisible"></div>
            <div class="flex-[1_0_auto] w-[25vw] max-w-[15.5rem] invisible"></div>
            <div class="flex items-center flex-[1_0_auto] w-[25vw] max-w-[15.5rem] h-16 p-2 bg-primary rounded-2xl">
              <label for="selectNamespace">ns</label>
              <select id="selectNamespace" class="w-full h-[2.75rem] ml-1 pl-1 bg-white text-primary rounded-lg" aria-label="Select namespace"
                      hx-trigger="change" hx-get="page/resources/{resource.group ?: "null"}/{resource.name}" hx-target="#resourceItemsContainer">
                <option value=" " {#if selectedNamespace == null}selected{/if}>all</option>
                {#for namespace in allNamespaces}
                  <option value="{namespace.name}" {#if namespace.name == selectedNamespace}selected{/if}>{namespace.name}</option>
                {/for}
              </select>
            </div>
          </div>

          <div class="flex flex-wrap py-[0.125rem]">
            <div class="mobile-command-item" hx-get="page/resources/ /persistentvolumes" hx-target="#resourceItemsContainer">PV</div>
            <div class="mobile-command-item" hx-get="page/resources/ /persistentvolumeclaims" hx-target="#resourceItemsContainer">PVC</div>
            <div class="mobile-command-item" hx-get="page/resources/ /nodes" hx-target="#resourceItemsContainer">Nodes</div>

            <div class="mobile-command-item" hx-get="page/resources/rbac.authorization.k8s.io/rolebindings" hx-target="#resourceItemsContainer">RoleBindings</div>
            <div class="mobile-command-item" hx-get="page/resources/rbac.authorization.k8s.io/clusterroles" hx-target="#resourceItemsContainer">ClusterRoles</div>
            <div class="mobile-command-item" hx-get="page/resources/rbac.authorization.k8s.io/roles" hx-target="#resourceItemsContainer">Roles</div>

            <div class="mobile-command-item" hx-get="page/resources/ /serviceaccounts" hx-target="#resourceItemsContainer">ServiceAccounts</div>
            <div class="mobile-command-item" hx-get="page/resources/ /secrets" hx-target="#resourceItemsContainer">Secrets</div>
            <div class="mobile-command-item" hx-get="page/resources/ /configmaps" hx-target="#resourceItemsContainer">ConfigMaps</div>

            <div class="mobile-command-item" hx-get="page/resources/apps/daemonsets" hx-target="#resourceItemsContainer">DaemonSets</div>
            <div class="mobile-command-item" hx-get="page/resources/apps/statefulsets" hx-target="#resourceItemsContainer">StatefulSets</div>
            <div class="mobile-command-item" hx-get="page/resources/apps/deployments" hx-target="#resourceItemsContainer">Deployments</div>

            <div class="mobile-command-item" hx-get="page/resources/networking.k8s.io/ingresses" hx-target="#resourceItemsContainer">Ingresses</div>
            <div class="mobile-command-item" hx-get="page/resources/ /services" hx-target="#resourceItemsContainer">Services</div>
            <div class="mobile-command-item" hx-get="page/resources/ /pods" hx-target="#resourceItemsContainer">Pods</div>
          </div>
        </div>
      </div>

      <script type="text/javascript">
        const commandNamesToUrlPath = new Map() // copy commands so that we can access them from JavaScript
        {#for entry in commandNamesToUrlPath}
          commandNamesToUrlPath.set("{entry.key}", "{entry.value}")
        {/for}
        const commandInputContainer = document.getElementById("commandInputContainer")
        const commandInput = commandInputContainer.querySelector("input")
        const commandsContainer = document.getElementById("commandsContainer")
        const resourceItemsContainer = document.getElementById("resourceItemsContainer")
        var selectedItem = null
        var previousFocusedElement = null

        initializeTable()

        const observer = new MutationObserver((mutationList) => {
          initializeTable() // table data has changed, so re-initialize table
        })
        observer.observe(resourceItemsContainer, { childList: true })

        function initializeTable() {
          const firstTableRow = resourceItemsContainer.querySelector("tbody tr")
          if (firstTableRow) { // there are items in the table
            selectedItem = firstTableRow
            selectedItem.focus()
          }
        }

        window.onkeydown = (event) => {
          if (event.code == "Period" && document.activeElement != commandInput) { // show and focus commandInput on ':'
            previousFocusedElement = document.activeElement // store current focused element to restore focus when hiding commandInput
            commandInputContainer.classList.remove("hidden")
            commandInput.focus()
            event.preventDefault()
          }
        }

        function onTableRowMouseDown(event) {
          const parentRowElement = event.srcElement.closest("tr")
          if (parentRowElement) {
            setFocusTo(null, parentRowElement) // do not prevent default -> null for event
          } else if (event.srcElement.tagName == "TR") {
            setFocusTo(null, event.srcElement)
          }
        }

        function onTableRowKeyDown(event) {
          if (noModifierKeyPressed(event)) {
            if (event.code == "ArrowDown") {
              setFocusTo(event, selectedItem?.nextElementSibling)
            }
            else if (event.code == "ArrowUp") {
              setFocusTo(event, selectedItem?.previousElementSibling)
            }
            else if (event.code == "KeyL") {
              if (selectedItem == event.srcElement && selectedItem.dataset.logsUrl) {
                window.open(selectedItem.dataset.logsUrl, "_blank", "popup=true,toolbar=true")
                event.preventDefault()
              }
            }
          }
        }

        function setFocusTo(event, item) {
          if (item) {
            selectedItem = item
            item.focus()
            event?.preventDefault()
          }
        }

        function noModifierKeyPressed(event) {
          return !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey
        }

        function commandInputKeyDown(event) {
          if (event.code == "Escape") { // hide commandInput on Escape
            commandInput.blur()
            event.preventDefault()
          }
        }

        function commandInputLostFocus(event) {
          commandInputContainer.classList.add("hidden")
          commandInput.value = ""
          previousFocusedElement?.focus()
        }

        document.body.addEventListener('htmx:configRequest', function(event) {
          if (event.detail.path.startsWith("page/resources/<resourcePath>")) { // fill path template with values of selected resources and hide commandInput
            const hasFocus = document.activeElement == commandInput
            if (hasFocus == false) { // this method also gets fired when commandInput just gets hidden, e.g. when pressing Escape ->
              event.preventDefault()
              return
            }

            if (event.detail.path.endsWith("?namespace=")) {
              event.detail.path = event.detail.path.replace("?namespace=", "")
            }
            event.detail.path = event.detail.path
                .replace("?namespace=null", "")
                .replace("<resourcePath>", commandNamesToUrlPath.get(event.detail.elt.value))
            commandInput.blur()
          } else if (event.detail.path.startsWith("resource/")) {
            if (event.detail.verb == "delete") {
              event.detail.triggeringEvent.preventDefault() // prevent Ctrl+D and Ctrl+K from bubbling on
            } else if (event.detail.verb == "patch") {
              event.detail.path = event.detail.path + "?scaleTo=" + event.detail.headers["HX-Prompt"]
              event.detail.triggeringEvent.preventDefault() // prevent key 'S' from bubbling on
            }
          } else if (event.detail.path.startsWith("page/resources/")) {
            if (event.srcElement.classList.contains("mobile-command-item")) { // a mobile command item has been clicked ..
              commandsContainer.classList.add("hidden") // .. -> hide commandsContainer again
              event.detail.triggeringEvent.preventDefault() // stop propagating so that it won't reach window.onclick listener which hides commandsContainer
            } else if (event.srcElement.id == "selectNamespace") {
              if (event.srcElement.value && event.srcElement.value != " ") {
                event.detail.path = event.detail.path + "?namespace=" + event.srcElement.value
              }
              commandsContainer.classList.add("hidden")
            }
          }
        })

        document.addEventListener("click", (event) => {
          if (event.defaultPrevented == false && commandsContainer.contains(event.srcElement) == false) {
            commandsContainer.classList.add("hidden") // click outside commandsContainer -> hide commandsContainer again
          }
        })
      </script>
  </div>
{/include}